<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>AFL Manager (Prototype)</title>
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #101826;
      --panel2: #0e1521;
      --text: #e6edf7;
      --muted: #9fb0c7;
      --line: rgba(255,255,255,0.08);
      --good: #46d17a;
      --bad: #ff5a6a;
      --warn: #ffcc66;
      --accent: #7aa7ff;
      --accent2: #b68cff;

      --r: 14px;
      --pad: 14px;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }

    *{ box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body{
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(122,167,255,0.18), transparent 40%),
                  radial-gradient(900px 500px at 90% 10%, rgba(182,140,255,0.14), transparent 45%),
                  var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      overflow-x: hidden;
    }

    .app{
      min-height: 100%;
      padding: calc(var(--safe-top) + 10px) calc(var(--safe-left) + 12px) calc(var(--safe-bot) + 90px) calc(var(--safe-right) + 12px);
      max-width: 980px;
      margin: 0 auto;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(to bottom, rgba(11,15,20,0.95), rgba(11,15,20,0.65));
      backdrop-filter: blur(10px);
      padding: 10px 0 12px 0;
      margin-bottom: 10px;
    }

    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .brand .title{
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 18px;
      line-height: 1.1;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      background: rgba(16,24,38,0.55);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    .pill b{ color: var(--text); font-weight: 700; }

    .row{ display:flex; gap: 10px; flex-wrap: wrap; }
    .row > * { flex: 1 1 auto; }

    .card{
      background: linear-gradient(180deg, rgba(16,24,38,0.95), rgba(14,21,33,0.95));
      border: 1px solid var(--line);
      border-radius: var(--r);
      padding: var(--pad);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .card h2{
      margin: 0 0 8px 0;
      font-size: 16px;
      letter-spacing: 0.2px;
    }
    .card p{
      margin: 6px 0;
      color: var(--muted);
      line-height: 1.4;
      font-size: 13px;
    }

    .btnbar{ display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button{
      appearance:none;
      border: 1px solid var(--line);
      background: rgba(16,24,38,0.75);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 650;
      letter-spacing: 0.2px;
      cursor:pointer;
      flex: 1 1 auto;
      min-width: 120px;
    }
    button:active{ transform: translateY(1px); }
    button.primary{
      border-color: rgba(122,167,255,0.55);
      background: linear-gradient(180deg, rgba(122,167,255,0.22), rgba(122,167,255,0.10));
    }
    button.danger{
      border-color: rgba(255,90,106,0.55);
      background: linear-gradient(180deg, rgba(255,90,106,0.18), rgba(255,90,106,0.08));
    }
    button.small{
      padding: 9px 10px;
      font-size: 13px;
      min-width: 90px;
    }
    button:disabled{
      opacity: 0.45;
      cursor:not-allowed;
    }

    .tabs{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px calc(var(--safe-left) + 10px) calc(var(--safe-bot) + 10px) calc(var(--safe-right) + 10px);
      background: linear-gradient(to top, rgba(11,15,20,0.95), rgba(11,15,20,0.65));
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
      z-index: 20;
    }
    .tabs .tabrow{
      display:flex;
      gap: 10px;
      max-width: 980px;
      margin: 0 auto;
    }
    .tab{
      flex: 1 1 0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 4px;
      padding: 10px 0;
      border-radius: 12px;
      border: 1px solid transparent;
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(122,167,255,0.35);
      background: rgba(16,24,38,0.55);
      color: var(--text);
    }
    .tab .icon{ font-size: 16px; line-height: 1; }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .grid2{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 720px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin-top: 8px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid var(--line);
      background: rgba(16,24,38,0.45);
      border-radius: 12px;
    }
    .item .left{ display:flex; flex-direction:column; gap: 2px; }
    .item .name{ font-weight: 750; font-size: 14px; }
    .item .meta{ color: var(--muted); font-size: 12px; }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      color: var(--muted);
      white-space: nowrap;
    }
    .badge.good{ color: var(--good); border-color: rgba(70,209,122,0.35); background: rgba(70,209,122,0.08); }
    .badge.bad{ color: var(--bad); border-color: rgba(255,90,106,0.35); background: rgba(255,90,106,0.08); }
    .badge.warn{ color: var(--warn); border-color: rgba(255,204,102,0.35); background: rgba(255,204,102,0.08); }
    .badge.accent{ color: var(--accent); border-color: rgba(122,167,255,0.35); background: rgba(122,167,255,0.08); }

    table{
      width: 100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(16,24,38,0.35);
      font-size: 13px;
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: middle;
    }
    th{ color: var(--muted); font-weight: 700; font-size: 12px; letter-spacing: 0.2px; }
    tr:last-child td{ border-bottom: none; }

    .mono{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
    .right{ text-align:right; }

    .toast{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: calc(var(--safe-bot) + 78px);
      max-width: 980px;
      margin: 0 auto;
      z-index: 30;
      display:none;
    }
    .toast.show{ display:block; }
    .toast .card{ padding: 12px; }
    .toast .msg{ color: var(--text); font-size: 13px; }
    .toast .hint{ color: var(--muted); font-size: 12px; margin-top: 4px; }

    .seg{
      display:flex;
      gap: 8px;
      border: 1px solid var(--line);
      background: rgba(16,24,38,0.35);
      padding: 6px;
      border-radius: 12px;
      width: fit-content;
    }
    .seg button{
      border: 1px solid transparent;
      background: transparent;
      padding: 8px 10px;
      border-radius: 10px;
      min-width: 90px;
      font-size: 13px;
      color: var(--muted);
    }
    .seg button.active{
      border-color: rgba(122,167,255,0.35);
      background: rgba(122,167,255,0.10);
      color: var(--text);
    }

    .hidden{ display:none !important; }
    .spacer{ height: 10px; }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="toprow">
        <div class="brand">
          <div class="title">AFL Manager <span class="badge accent">Prototype</span></div>
          <div class="sub" id="topSub">No career loaded</div>
        </div>
        <div class="pill mono" id="topPill">
          <span id="pillClub">‚Äî</span>
          <span>‚Ä¢</span>
          <span id="pillRound">R‚Äî</span>
          <span>‚Ä¢</span>
          <b id="pillRecord">‚Äî</b>
        </div>
      </div>
    </header>

    <!-- SCREEN: MAIN -->
    <section class="screen active" id="screen-main">
      <div class="grid2">
        <div class="card">
          <h2>New Career</h2>
          <p>Generated league, generated players, generated draft. One club career. Realistic scoring pace.</p>

          <div class="row">
            <div class="pill">Seed: <b class="mono" id="seedLabel">20260119</b></div>
            <div class="pill">Clubs: <b class="mono">18</b></div>
            <div class="pill">Players/Club: <b class="mono">44</b></div>
          </div>

          <div class="btnbar">
            <button class="primary" id="btnNewCareer">Generate League</button>
            <button id="btnResetAll" class="danger">Reset</button>
          </div>

          <p class="muted">Tip: if you keep the same seed, you get the same league again (useful for testing).</p>
        </div>

        <div class="card">
          <h2>Choose Club</h2>
          <p>Pick your club after generating the league.</p>
          <div class="list" id="clubList"></div>
        </div>
      </div>
    </section>

    <!-- SCREEN: HUB -->
    <section class="screen" id="screen-hub">
      <div class="grid2">
        <div class="card">
          <h2>Weekly Hub</h2>
          <p class="mono" id="hubWeekLine">Season ‚Äî ‚Ä¢ Round ‚Äî</p>

          <div class="spacer"></div>
          <div class="seg" aria-label="Training focus">
            <button id="focusBalanced" class="active">Balanced</button>
            <button id="focusFitness">Fitness</button>
            <button id="focusSkills">Skills</button>
            <button id="focusTactics">Tactics</button>
            <button id="focusRehab">Rehab</button>
          </div>

          <div class="btnbar">
            <button class="primary" id="btnAutoPick">Auto Pick Best 22</button>
            <button class="primary" id="btnPlayMatch">Play This Round (User Match)</button>
            <button id="btnSimRound">Sim Rest of Round</button>
            <button id="btnAdvanceRound">Advance to Next Round</button>
          </div>

          <div class="row">
            <div class="pill">Selected 22: <b class="mono" id="selCount">0</b></div>
            <div class="pill">Avg Rating: <b class="mono" id="selAvg">‚Äî</b></div>
            <div class="pill">Injuries: <b class="mono" id="injCount">‚Äî</b></div>
          </div>
        </div>

        <div class="card">
          <h2>Your Squad (Top 12 by rating)</h2>
          <div class="list" id="squadPreview"></div>
          <div class="btnbar">
            <button id="btnGoTeam">Team</button>
            <button id="btnGoLadder">Ladder</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SCREEN: TEAM -->
    <section class="screen" id="screen-team">
      <div class="card">
        <h2>Team Selection</h2>
        <p>Tap players to toggle selection. Keep it at 22 (prototype will allow over/under for now; we‚Äôll hard-enforce later).</p>
        <div class="btnbar">
          <button class="primary" id="btnTeamAutoPick">Auto Pick Best 22</button>
          <button id="btnTeamClear">Clear</button>
          <button id="btnTeamBack">Back to Hub</button>
        </div>

        <div class="row">
          <div class="pill">Selected: <b class="mono" id="teamSelectedCount">0</b></div>
          <div class="pill">Avg Rating: <b class="mono" id="teamAvgRating">‚Äî</b></div>
        </div>

        <div class="spacer"></div>
        <div class="list" id="teamList"></div>
      </div>
    </section>

    <!-- SCREEN: MATCH -->
    <section class="screen" id="screen-match">
      <div class="grid2">
        <div class="card">
          <h2>Match Center</h2>
          <p class="mono" id="matchHeader">‚Äî</p>

          <div class="row">
            <div class="pill">QTR: <b class="mono" id="mQ">0</b></div>
            <div class="pill">TIME: <b class="mono" id="mT">‚Äî</b></div>
            <div class="pill">SPEED: <b class="mono" id="mS">Medium</b></div>
          </div>

          <div class="spacer"></div>
          <div class="seg" aria-label="Sim speed">
            <button id="speedSlow">Slow</button>
            <button id="speedMed" class="active">Medium</button>
            <button id="speedFast">Fast</button>
          </div>

          <div class="btnbar">
            <button class="primary" id="btnMatchStart">Start Match</button>
            <button id="btnMatchPause">Pause</button>
            <button id="btnMatchExit">Exit</button>
          </div>

          <div class="card" style="margin-top:10px; background: rgba(16,24,38,0.35);">
            <div class="row">
              <div class="pill mono" style="flex:1">
                <span id="homeName">HOME</span>
                <span class="right" style="margin-left:auto"><b id="homeScore">0.0 (0)</b></span>
              </div>
              <div class="pill mono" style="flex:1">
                <span id="awayName">AWAY</span>
                <span class="right" style="margin-left:auto"><b id="awayScore">0.0 (0)</b></span>
              </div>
            </div>
            <p class="muted" id="quarterLine">Q1: 0-0 ‚Ä¢ Q2: 0-0 ‚Ä¢ Q3: 0-0 ‚Ä¢ Q4: 0-0</p>
          </div>
        </div>

        <div class="card">
          <h2>Live Feed</h2>
          <p>Quarter-by-quarter events. On Fast speed this flies.</p>
          <div class="list" id="feed"></div>
        </div>
      </div>
    </section>

    <!-- SCREEN: LADDER -->
    <section class="screen" id="screen-ladder">
      <div class="card">
        <h2>Ladder</h2>
        <div class="btnbar">
          <button id="btnLadderBack">Back to Hub</button>
        </div>
        <div class="spacer"></div>
        <div style="overflow:auto;">
          <table id="ladderTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Club</th>
                <th class="right">P</th>
                <th class="right">W</th>
                <th class="right">L</th>
                <th class="right">D</th>
                <th class="right">Pts</th>
                <th class="right">%</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="muted">Finals + offseason + draft screens get added in later chunks.</p>
      </div>
    </section>
  </div>

  <!-- bottom nav -->
  <nav class="tabs" aria-label="Bottom Navigation">
    <div class="tabrow">
      <div class="tab active" data-go="main"><div class="icon">üèÅ</div><div>Main</div></div>
      <div class="tab" data-go="hub"><div class="icon">üèüÔ∏è</div><div>Hub</div></div>
      <div class="tab" data-go="team"><div class="icon">üìã</div><div>Team</div></div>
      <div class="tab" data-go="match"><div class="icon">‚è±Ô∏è</div><div>Match</div></div>
      <div class="tab" data-go="ladder"><div class="icon">üìä</div><div>Ladder</div></div>
    </div>
  </nav>

  <div class="toast" id="toast">
    <div class="card">
      <div class="msg" id="toastMsg">‚Äî</div>
      <div class="hint" id="toastHint">‚Äî</div>
    </div>
  </div>

  <script>
  /*****************************************************************
   * AFL Manager Prototype (Chunked Single-File)
   * Chunk 1/5: UI layout + routing + empty stubs
   *
   * Next chunks will fill in:
   *  - League generation (clubs/players) + save/load
   *  - Season fixture + ladder logic
   *  - Match sim + speed toggle (realistic scoring)
   *  - Draft + offseason
   *****************************************************************/

  // ---------- Simple App State ----------
  const App = {
    seed: 20260119,
    hasCareer: false,
    userClubId: null,
    trainingFocus: "Balanced",
    // these will be filled in later chunks:
    league: null,     // { clubs:[], playersById:{} }
    season: null,     // { year, roundIndex, rounds:[], ladder:{} }
    selection: null,  // { selectedIds:[] }
    match: null       // runtime match controller
  };

  // ---------- DOM Helpers ----------
  const $ = (id) => document.getElementById(id);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function toast(msg, hint=""){
    $("toastMsg").textContent = msg;
    $("toastHint").textContent = hint;
    $("toast").classList.add("show");
    setTimeout(()=> $("toast").classList.remove("show"), 2200);
  }

  // ---------- Screen Routing ----------
  const screens = ["main","hub","team","match","ladder"];

  function go(screen){
    for (const s of screens){
      const el = $("screen-" + s);
      if (!el) continue;
      el.classList.toggle("active", s === screen);
    }
    for (const t of $$(".tab")){
      t.classList.toggle("active", t.dataset.go === screen);
    }
    refreshTopBar();
    refreshVisibleScreen();
  }

  // ---------- Top Bar ----------
  function refreshTopBar(){
    if (!App.hasCareer){
      $("topSub").textContent = "No career loaded";
      $("pillClub").textContent = "‚Äî";
      $("pillRound").textContent = "R‚Äî";
      $("pillRecord").textContent = "‚Äî";
      return;
    }
    const club = getUserClub();
    const roundNo = (App.season?.roundIndex ?? 0) + 1;

    $("topSub").textContent = `Season ${App.season?.year ?? "‚Äî"} ‚Ä¢ Round ${roundNo}`;
    $("pillClub").textContent = club ? club.name + " " + club.nick : "‚Äî";
    $("pillRound").textContent = "R" + roundNo;

    const rec = getUserRecord();
    $("pillRecord").textContent = rec ? `${rec.w}-${rec.l}-${rec.d}` : "‚Äî";
  }

  function refreshVisibleScreen(){
    const active = screens.find(s => $("screen-" + s)?.classList.contains("active")) || "main";
    if (active === "main") renderMain();
    if (active === "hub") renderHub();
    if (active === "team") renderTeam();
    if (active === "match") renderMatch();
    if (active === "ladder") renderLadder();
  }

  // ---------- UI: Main ----------
  function renderMain(){
    $("seedLabel").textContent = String(App.seed);
    const list = $("clubList");
    list.innerHTML = "";
    if (!App.hasCareer || !App.league){
      list.innerHTML = `<div class="item"><div class="left"><div class="name">No league yet</div><div class="meta">Tap ‚ÄúGenerate League‚Äù first</div></div><span class="badge">‚Äî</span></div>`;
      return;
    }
    for (const c of App.league.clubs){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="left">
          <div class="name">${escapeHtml(c.name)} ${escapeHtml(c.nick)}</div>
          <div class="meta mono">Club ID: ${c.id}</div>
        </div>
        <button class="small primary">Choose</button>
      `;
      div.querySelector("button").addEventListener("click", ()=>{
        App.userClubId = c.id;
        toast("Club selected", `${c.name} ${c.nick}`);
        go("hub");
      });
      list.appendChild(div);
    }
  }

  // ---------- UI: Hub ----------
  function renderHub(){
    if (!App.hasCareer) {
      toast("Create a career first", "Go to Main ‚Üí Generate League");
      go("main");
      return;
    }

    const roundNo = (App.season.roundIndex ?? 0) + 1;
    $("hubWeekLine").textContent = `Season ${App.season.year} ‚Ä¢ Round ${roundNo}`;

    // focus UI
    const focusButtons = {
      Balanced: $("focusBalanced"),
      Fitness: $("focusFitness"),
      Skills: $("focusSkills"),
      Tactics: $("focusTactics"),
      Rehab: $("focusRehab")
    };
    for (const k in focusButtons){
      focusButtons[k].classList.toggle("active", App.trainingFocus === k);
    }

    // placeholders until later chunks populate selections + injuries
    $("selCount").textContent = (App.selection?.selectedIds?.length ?? 0);
    $("selAvg").textContent = "‚Äî";
    $("injCount").textContent = "‚Äî";

    renderSquadPreview();
  }

  function renderSquadPreview(){
    const box = $("squadPreview");
    box.innerHTML = "";
    if (!App.league || !App.userClubId){
      box.innerHTML = `<div class="item"><div class="left"><div class="name">No club selected</div><div class="meta">Pick a club on the Main screen</div></div></div>`;
      return;
    }
    // Will be replaced with real player data in Chunk 2
    box.innerHTML = `<div class="item"><div class="left"><div class="name">Players will appear after Chunk 2</div><div class="meta">We‚Äôll generate ratings (1‚Äì99) and list your top players here</div></div></div>`;
  }

  // ---------- UI: Team ----------
  function renderTeam(){
    if (!App.hasCareer) { go("main"); return; }
    $("teamSelectedCount").textContent = (App.selection?.selectedIds?.length ?? 0);
    $("teamAvgRating").textContent = "‚Äî";
    $("teamList").innerHTML = `<div class="item"><div class="left"><div class="name">Team screen activates in Chunk 2</div><div class="meta">You‚Äôll be able to tap to select 22</div></div></div>`;
  }

  // ---------- UI: Match ----------
  function renderMatch(){
    if (!App.hasCareer) { go("main"); return; }
    $("feed").innerHTML = `<div class="item"><div class="left"><div class="name">Match engine loads in Chunk 4</div><div class="meta">Quarter-by-quarter sim with Slow/Medium/Fast</div></div></div>`;
  }

  // ---------- UI: Ladder ----------
  function renderLadder(){
    if (!App.hasCareer) { go("main"); return; }
    const tbody = $("ladderTable").querySelector("tbody");
    tbody.innerHTML = `<tr><td colspan="8" style="color: var(--muted);">Ladder loads in Chunk 3</td></tr>`;
  }

  // ---------- Event wiring ----------
  // Bottom tabs
  $$(".tab").forEach(t => t.addEventListener("click", ()=> go(t.dataset.go)));

  // Main buttons
  $("btnNewCareer").addEventListener("click", ()=>{
    // will be implemented in Chunk 2
    toast("Chunk 2 required", "Next we‚Äôll add league + player generation");
  });

  $("btnResetAll").addEventListener("click", ()=>{
    Object.assign(App, {
      hasCareer: false,
      userClubId: null,
      trainingFocus: "Balanced",
      league: null,
      season: null,
      selection: null,
      match: null
    });
    toast("Reset complete", "All data cleared");
    go("main");
  });

  // Hub focus buttons
  $("focusBalanced").addEventListener("click", ()=> { App.trainingFocus="Balanced"; renderHub(); });
  $("focusFitness").addEventListener("click", ()=> { App.trainingFocus="Fitness"; renderHub(); });
  $("focusSkills").addEventListener("click", ()=> { App.trainingFocus="Skills"; renderHub(); });
  $("focusTactics").addEventListener("click", ()=> { App.trainingFocus="Tactics"; renderHub(); });
  $("focusRehab").addEventListener("click", ()=> { App.trainingFocus="Rehab"; renderHub(); });

  // Hub nav
  $("btnGoTeam").addEventListener("click", ()=> go("team"));
  $("btnGoLadder").addEventListener("click", ()=> go("ladder"));

  // Hub actions (stubs for now)
  $("btnAutoPick").addEventListener("click", ()=> toast("Chunk 2 required", "Auto-pick needs generated players"));
  $("btnPlayMatch").addEventListener("click", ()=> toast("Chunk 4 required", "Match engine comes later"));
  $("btnSimRound").addEventListener("click", ()=> toast("Chunk 3 required", "Season + fixture comes next"));

  // Team buttons (stubs)
  $("btnTeamAutoPick").addEventListener("click", ()=> toast("Chunk 2 required", "Auto-pick needs generated players"));
  $("btnTeamClear").addEventListener("click", ()=> toast("Not ready yet", "Chunk 2 will implement selection"));
  $("btnTeamBack").addEventListener("click", ()=> go("hub"));

  // Ladder back
  $("btnLadderBack").addEventListener("click", ()=> go("hub"));

  // Match speed buttons (UI only for now)
  const speedButtons = { Slow: $("speedSlow"), Medium: $("speedMed"), Fast: $("speedFast") };
  let uiSpeed = "Medium";
  function setUiSpeed(s){
    uiSpeed = s;
    $("mS").textContent = s;
    for (const k in speedButtons) speedButtons[k].classList.toggle("active", k===s);
  }
  $("speedSlow").addEventListener("click", ()=> setUiSpeed("Slow"));
  $("speedMed").addEventListener("click", ()=> setUiSpeed("Medium"));
  $("speedFast").addEventListener("click", ()=> setUiSpeed("Fast"));

  $("btnMatchStart").addEventListener("click", ()=> toast("Chunk 4 required", "Match sim not installed yet"));
  $("btnMatchPause").addEventListener("click", ()=> toast("Chunk 4 required", "Pause/resume will be added"));
  $("btnMatchExit").addEventListener("click", ()=> go("hub"));

  // ---------- Utility ----------
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function getUserClub(){
    if (!App.league || !App.userClubId) return null;
    return App.league.clubs.find(c => c.id === App.userClubId) || null;
  }

  function getUserRecord(){
    // Ladder comes in Chunk 3, stub for now
    return null;
  }

  // initial paint
  refreshTopBar();
  </script>

  <!--
    ============================================================
    CHUNK INSERT POINTS (DO NOT DELETE)
    ============================================================

    [CHUNK 2] Data + League Generation + Save/Load
    Paste Chunk 2 below this line.

    [CHUNK 3] Season Fixture + Ladder + Round Simulation (AI)
    Paste Chunk 3 below Chunk 2.

    [CHUNK 4] Match Engine (Quarter-by-quarter) + Speed + Feed
    Paste Chunk 4 below Chunk 3.

    [CHUNK 5] Draft + Offseason + Progression
    Paste Chunk 5 below Chunk 4.
  -->

<script>
/*****************************************************************
 * CHUNK 2/5
 * League generation + players (1‚Äì99 ratings)
 * Auto-pick best 22
 * Save / Load (localStorage, iPhone safe)
 *****************************************************************/

// ---------- Constants ----------
const POSITIONS = ["DEF","MID","FWD","RUC"];
const ARCHETYPES = {
  DEF: ["Intercept","Lockdown"],
  MID: ["Inside","Outside","Wing"],
  FWD: ["Small","Medium","Key"],
  RUC: ["Ruck"]
};

const FIRST_NAMES = ["Jack","Tom","Liam","Noah","Harry","James","Ben","Will","Charlie","Sam","Josh","Luke","Max","Alex","Ryan","Caleb","Oscar","Matt","Nathan","Bailey"];
const LAST_NAMES  = ["Smith","Jones","Williams","Brown","Wilson","Martin","Taylor","Anderson","Thomas","White","Walker","Scott","King","Green","Baker","Adams","Clark","Hill","Evans","Murphy"];

const CLUB_NAMES = [
  ["Bayside","Sharks"],["Northern","Rangers"],["Western","Roos"],["Eastern","Falcons"],
  ["Harbour","Seagulls"],["Gippsland","Giants"],["Riverland","Crows"],["Highlands","Hawks"],
  ["Coastal","Tigers"],["Outback","Demons"],["Metro","Magpies"],["Southport","Lions"],
  ["Goldfields","Suns"],["Lakeside","Blues"],["Redwood","Bombers"],["Prairie","Bulldogs"],
  ["Stonebridge","Saints"],["Ironvale","Power"]
];

// ---------- RNG ----------
function rng(seed){
  let s = seed % 2147483647;
  return ()=> (s = s * 16807 % 2147483647) / 2147483647;
}

// ---------- League Generation ----------
function generateLeague(seed){
  const rand = rng(seed);
  const league = { clubs: [], playersById: {} };

  for (let i=0;i<18;i++){
    const c = {
      id: "C"+String(i).padStart(2,"0"),
      name: CLUB_NAMES[i][0],
      nick: CLUB_NAMES[i][1],
      playerIds: []
    };
    league.clubs.push(c);

    for (let p=0;p<44;p++){
      const pos = weightedPick(rand, [
        ["MID",0.32],["DEF",0.27],["FWD",0.29],["RUC",0.12]
      ]);
      const arch = ARCHETYPES[pos][Math.floor(rand()*ARCHETYPES[pos].length)];

      const age = 18 + Math.floor(rand()*15); // 18‚Äì32
      const base = 45 + Math.floor(rand()*30); // 45‚Äì75
      const agePeak = 1 - Math.abs(age-27)*0.015;

      let overall = Math.round(base * agePeak);
      overall = clamp(overall + Math.floor(rand()*7)-3, 35, 90);

      const pid = `${c.id}_P${p}`;
      const player = {
        id: pid,
        name: FIRST_NAMES[Math.floor(rand()*FIRST_NAMES.length)]+" "+
              LAST_NAMES[Math.floor(rand()*LAST_NAMES.length)],
        age,
        pos,
        arch,
        rating: overall,
        fatigue: Math.floor(rand()*10),
        injured: 0
      };

      league.playersById[pid] = player;
      c.playerIds.push(pid);
    }
  }
  return league;
}

// ---------- Auto Pick Best 22 ----------
function autoPick22(club){
  const players = club.playerIds
    .map(id => App.league.playersById[id])
    .filter(p => p.injured<=0)
    .sort((a,b)=>b.rating-a.rating);

  const picked = [];
  take(players,picked,p=>p.pos==="RUC",1);
  take(players,picked,p=>p.pos==="DEF",7);
  take(players,picked,p=>p.pos==="MID",8);
  take(players,picked,p=>p.pos==="FWD",6);

  while (picked.length<22 && players.length){
    picked.push(players.shift());
  }
  return picked.map(p=>p.id);
}

function take(src,dst,fn,n){
  const take = src.filter(fn).slice(0,n);
  take.forEach(p=>{
    dst.push(p);
    src.splice(src.indexOf(p),1);
  });
}

// ---------- Save / Load ----------
function saveCareer(){
  localStorage.setItem("aflm_save", JSON.stringify({
    seed: App.seed,
    league: App.league,
    season: App.season,
    userClubId: App.userClubId,
    selection: App.selection
  }));
}

function loadCareer(){
  const raw = localStorage.getItem("aflm_save");
  if (!raw) return false;
  const data = JSON.parse(raw);
  Object.assign(App, data);
  App.hasCareer = true;
  return true;
}

// ---------- UI Wiring Overrides ----------
$("btnNewCareer").onclick = ()=>{
  App.league = generateLeague(App.seed);
  App.hasCareer = true;
  App.userClubId = null;
  App.selection = { selectedIds: [] };
  saveCareer();
  toast("League generated","Pick your club");
  renderMain();
};

$("btnAutoPick").onclick = ()=>{
  if (!App.userClubId) return toast("Pick a club first");
  const club = getUserClub();
  App.selection.selectedIds = autoPick22(club);
  saveCareer();
  toast("Best 22 selected");
  renderHub();
};

$("btnTeamAutoPick").onclick = ()=>{
  if (!App.userClubId) return;
  App.selection.selectedIds = autoPick22(getUserClub());
  saveCareer();
  renderTeam();
};

// ---------- Render Squad Preview ----------
function renderSquadPreview(){
  const box = $("squadPreview");
  box.innerHTML = "";
  if (!App.userClubId) return;

  const club = getUserClub();
  const players = club.playerIds
    .map(id=>App.league.playersById[id])
    .sort((a,b)=>b.rating-a.rating)
    .slice(0,12);

  players.forEach(p=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="left">
        <div class="name">${escapeHtml(p.name)}</div>
        <div class="meta">${p.pos} ‚Ä¢ ${p.arch}</div>
      </div>
      <span class="badge accent mono">${p.rating}</span>`;
    box.appendChild(div);
  });
}

// ---------- Render Team ----------
function renderTeam(){
  const list = $("teamList");
  list.innerHTML = "";
  const club = getUserClub();
  if (!club) return;

  const sel = new Set(App.selection.selectedIds||[]);
  let sum=0;

  club.playerIds
    .map(id=>App.league.playersById[id])
    .sort((a,b)=>b.rating-a.rating)
    .forEach(p=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="left">
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${p.pos} ‚Ä¢ ${p.arch} ‚Ä¢ Age ${p.age}</div>
        </div>
        <span class="badge ${sel.has(p.id)?"good":"accent"} mono">${p.rating}</span>
      `;
      div.onclick = ()=>{
        if (sel.has(p.id)) sel.delete(p.id);
        else sel.add(p.id);
        App.selection.selectedIds = Array.from(sel);
        saveCareer();
        renderTeam();
      };
      list.appendChild(div);
      if (sel.has(p.id)) sum+=p.rating;
    });

  $("teamSelectedCount").textContent = sel.size;
  $("teamAvgRating").textContent = sel.size
    ? Math.round(sum/sel.size)
    : "‚Äî";
}

// ---------- Helpers ----------
function weightedPick(rand, arr){
  const sum = arr.reduce((a,b)=>a+b[1],0);
  let r = rand()*sum;
  for (const [v,w] of arr){
    r-=w;
    if (r<=0) return v;
  }
  return arr[arr.length-1][0];
}
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

// ---------- Load on start ----------
if (loadCareer()){
  toast("Career loaded","Welcome back");
  renderMain();
}
</script>

<script>
/* iPhone tap fix: bind touch + pointer + click for key buttons */
(function iosTapFix(){
  function bindTap(id, fn){
    const el = document.getElementById(id);
    if (!el) return;

    // Make sure nothing blocks taps
    el.disabled = false;
    el.style.pointerEvents = "auto";
    el.style.touchAction = "manipulation";
    el.style.webkitUserSelect = "none";

    const handler = (e) => {
      try { e.preventDefault(); } catch {}
      try { e.stopPropagation(); } catch {}
      fn();
      return false;
    };

    // Remove any old handlers by cloning
    const clone = el.cloneNode(true);
    el.parentNode.replaceChild(clone, el);

    clone.addEventListener("touchend", handler, { passive:false });
    clone.addEventListener("pointerup", handler, { passive:false });
    clone.addEventListener("click", handler, { passive:false });
  }

  function setFocus(focus){
    if (!window.App) return;
    App.trainingFocus = focus;
    if (typeof renderHub === "function") renderHub();
  }

  // Training focus buttons
  bindTap("focusBalanced", ()=> setFocus("Balanced"));
  bindTap("focusFitness",   ()=> setFocus("Fitness"));
  bindTap("focusSkills",    ()=> setFocus("Skills"));
  bindTap("focusTactics",   ()=> setFocus("Tactics"));
  bindTap("focusRehab",     ()=> setFocus("Rehab"));

  // (Optional) speed buttons too, so they never fail
  bindTap("speedSlow", ()=> { document.getElementById("mS").textContent="Slow"; });
  bindTap("speedMed",  ()=> { document.getElementById("mS").textContent="Medium"; });
  bindTap("speedFast", ()=> { document.getElementById("mS").textContent="Fast"; });
})();
</script>

<script>
/* Patch: make renderHub() safe before Chunk 3 creates App.season */
(function patchRenderHub(){
  window.renderHub = function renderHub(){
    if (!App.hasCareer) { go("main"); return; }

    const year = App.season?.year ?? "‚Äî";
    const roundIndex = App.season?.roundIndex ?? 0;
    const roundNo = roundIndex + 1;

    $("hubWeekLine").textContent = `Season ${year} ‚Ä¢ Round ${roundNo}`;

    // focus UI
    const focusButtons = {
      Balanced: $("focusBalanced"),
      Fitness: $("focusFitness"),
      Skills: $("focusSkills"),
      Tactics: $("focusTactics"),
      Rehab: $("focusRehab")
    };
    for (const k in focusButtons){
      if (!focusButtons[k]) continue;
      focusButtons[k].classList.toggle("active", App.trainingFocus === k);
    }

    // Selected 22 + Avg Rating
    const selIds = App.selection?.selectedIds ?? [];
    $("selCount").textContent = String(selIds.length);

    if (App.league && selIds.length){
      let sum = 0;
      for (const id of selIds){
        const p = App.league.playersById[id];
        if (p) sum += p.rating;
      }
      $("selAvg").textContent = String(Math.round(sum / selIds.length));
    } else {
      $("selAvg").textContent = "‚Äî";
    }

    // Injuries count
    const club = getUserClub();
    if (club && App.league){
      const inj = club.playerIds
        .map(id => App.league.playersById[id])
        .filter(p => p && p.injured > 0).length;
      $("injCount").textContent = String(inj);
    } else {
      $("injCount").textContent = "‚Äî";
    }

    // Preview
    if (typeof renderSquadPreview === "function") renderSquadPreview();
  };

  // Re-render immediately so UI reflects current focus
  if (document.getElementById("screen-hub")?.classList.contains("active")) {
    renderHub();
  }
})();
</script>

<script>
/* Hard override: training focus UI that cannot be blocked by renderHub */
(function hardTrainingFocus(){
  const ids = {
    Balanced: "focusBalanced",
    Fitness:  "focusFitness",
    Skills:   "focusSkills",
    Tactics:  "focusTactics",
    Rehab:    "focusRehab"
  };

  function paint(){
    for (const k in ids){
      const el = document.getElementById(ids[k]);
      if (!el) continue;
      el.classList.toggle("active", App.trainingFocus === k);
    }
    // also update the hub line safely
    const year = App.season?.year ?? "‚Äî";
    const roundNo = (App.season?.roundIndex ?? 0) + 1;
    const hubLine = document.getElementById("hubWeekLine");
    if (hubLine) hubLine.textContent = `Season ${year} ‚Ä¢ Round ${roundNo}`;
  }

  function bind(id, focus){
    const el = document.getElementById(id);
    if (!el) return;

    // Ensure taps register on iOS
    el.style.pointerEvents = "auto";
    el.style.touchAction = "manipulation";

    const handler = (e) => {
      try { e.preventDefault(); } catch {}
      try { e.stopPropagation(); } catch {}

      App.trainingFocus = focus;
      paint();

      if (typeof toast === "function") toast("Training focus set", focus);
      if (typeof saveCareer === "function") saveCareer();
      return false;
    };

    el.addEventListener("touchend", handler, { passive:false });
    el.addEventListener("pointerup", handler, { passive:false });
    el.addEventListener("click", handler, { passive:false });
  }

  // Bind all
  bind(ids.Balanced, "Balanced");
  bind(ids.Fitness,  "Fitness");
  bind(ids.Skills,   "Skills");
  bind(ids.Tactics,  "Tactics");
  bind(ids.Rehab,    "Rehab");

  // Paint once now
  paint();
})();
</script>

  <script>
/*****************************************************************
 * CHUNK 3/5
 * Season fixture (23 rounds), ladder, simulate AI games
 *****************************************************************/

// ---------- Season / Ladder ----------
function newSeason(year=2026){
  const season = {
    year,
    roundIndex: 0,
    rounds: [],      // [{ number, games:[{home,away,played,hs,has,as,abs}] }]
    ladder: {}       // clubId -> entry
  };

  for (const c of App.league.clubs){
    season.ladder[c.id] = {
      clubId: c.id,
      played: 0, wins: 0, losses: 0, draws: 0,
      pf: 0, pa: 0
    };
  }
  return season;
}

function ladderPct(e){
  return e.pa === 0 ? 999.0 : (e.pf * 100.0) / e.pa;
}

function ladderPts(e){
  return e.wins * 4 + e.draws * 2;
}

function applyResultToLadder(fx){
  const home = App.season.ladder[fx.home];
  const away = App.season.ladder[fx.away];

  home.played++; away.played++;
  home.pf += fx.homePts; home.pa += fx.awayPts;
  away.pf += fx.awayPts; away.pa += fx.homePts;

  if (fx.homePts > fx.awayPts){ home.wins++; away.losses++; }
  else if (fx.homePts < fx.awayPts){ away.wins++; home.losses++; }
  else { home.draws++; away.draws++; }
}

// ---------- Fixture generation (round-robin base + extra rounds) ----------
function generateFixture23(){
  const ids = App.league.clubs.map(c=>c.id);
  const baseRounds = roundRobin(ids);   // 17 rounds
  const rounds = [];

  for (let i=0;i<baseRounds.length;i++){
    rounds.push({ number: i+1, games: baseRounds[i].map(pair=>mkFx(pair[0],pair[1])) });
  }

  // extra rounds to reach 23
  while (rounds.length < 23){
    const lastPairs = new Set();
    if (rounds.length){
      for (const g of rounds[rounds.length-1].games){
        lastPairs.add(normPair(g.home,g.away));
      }
    }
    const extra = randomPairRound(ids, lastPairs);
    rounds.push({ number: rounds.length+1, games: extra.map(pair=>mkFx(pair[0],pair[1])) });
  }

  return rounds;
}

function mkFx(home, away){
  return { home, away, played:false, homeG:0, homeB:0, awayG:0, awayB:0, homePts:0, awayPts:0 };
}

function normPair(a,b){ return a < b ? `${a}-${b}` : `${b}-${a}`; }

// Circle method round robin (17 rounds for 18 clubs)
function roundRobin(ids){
  const arr = ids.slice();
  if (arr.length % 2 === 1) arr.push("BYE");
  const n = arr.length;
  const rounds = n - 1;
  const half = n / 2;

  const out = [];
  let list = arr.slice();

  for (let r=0;r<rounds;r++){
    const pairs = [];
    for (let i=0;i<half;i++){
      const a = list[i];
      const b = list[n-1-i];
      if (a === "BYE" || b === "BYE") continue;

      // alternate home/away
      const flip = (r % 2) === 1;
      pairs.push(flip ? [b,a] : [a,b]);
    }
    out.push(pairs);

    // rotate, keep first fixed
    const last = list.pop();
    list.splice(1,0,last);
  }

  return out;
}

function randomPairRound(ids, lastPairs){
  const rand = rng(App.seed + 999 + App.season?.roundIndex*17 || 123);
  const pool = ids.slice();
  const pairs = [];

  while (pool.length >= 2){
    const a = pool.splice(Math.floor(rand()*pool.length),1)[0];

    // choose opponent not in last round if possible
    let candidates = pool.filter(x => !lastPairs.has(normPair(a,x)));
    if (candidates.length === 0) candidates = pool;

    const b = candidates[Math.floor(rand()*candidates.length)];
    pool.splice(pool.indexOf(b),1);

    // coin flip home/away
    const flip = rand() < 0.5;
    pairs.push(flip ? [a,b] : [b,a]);
  }
  return pairs;
}

// ---------- Team strength from selected IDs (avg rating only for now) ----------
function avgRatingOf(ids){
  if (!ids || !ids.length) return 50;
  let sum = 0, n=0;
  for (const id of ids){
    const p = App.league.playersById[id];
    if (!p) continue;
    sum += p.rating;
    n++;
  }
  return n ? (sum/n) : 50;
}

// ---------- AI game sim (realistic scoring pace) ----------
function simAIGame(homeId, awayId){
  // Use best 22 for AI clubs
  const homeClub = App.league.clubs.find(c=>c.id===homeId);
  const awayClub = App.league.clubs.find(c=>c.id===awayId);

  const home22 = autoPick22(homeClub);
  const away22 = autoPick22(awayClub);

  const homeAvg = avgRatingOf(home22); // 35..90 typical
  const awayAvg = avgRatingOf(away22);

  // Convert rating to advantage
  const diff = homeAvg - awayAvg; // +/- ~10
  const baseShots = 25;           // typical team shots
  const baseAcc = 0.52;           // realistic accuracy

  // Shots influenced by diff + random
  const homeShots = clampInt(Math.round(baseShots + diff*0.55 + randNorm(0, 3.2)), 16, 36);
  const awayShots = clampInt(Math.round(baseShots - diff*0.45 + randNorm(0, 3.2)), 16, 36);

  // Accuracy influenced by rating slightly
  const homeAcc = clamp(baseAcc + (homeAvg-60)*0.0012 + randNorm(0, 0.02), 0.44, 0.60);
  const awayAcc = clamp(baseAcc + (awayAvg-60)*0.0012 + randNorm(0, 0.02), 0.44, 0.60);

  const homeGoals = binom(homeShots, homeAcc);
  const awayGoals = binom(awayShots, awayAcc);

  const homeBehinds = Math.max(0, homeShots - homeGoals);
  const awayBehinds = Math.max(0, awayShots - awayGoals);

  return {
    homeG: homeGoals, homeB: homeBehinds,
    awayG: awayGoals, awayB: awayBehinds
  };
}

function clampInt(v,min,max){ return Math.max(min,Math.min(max,v)); }

// Gaussian approx
function randNorm(mean, std){
  // Box-Muller using deterministic-ish randomness from Math.random() is fine here
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0*Math.PI*v);
  return mean + z*std;
}

// Binomial
function binom(n,p){
  let x=0;
  for (let i=0;i<n;i++) if (Math.random() < p) x++;
  return x;
}

// ---------- Round simulation ----------
function currentRound(){
  return App.season.rounds[App.season.roundIndex];
}

function simulateRestOfRound(){
  const rnd = currentRound();
  if (!rnd) return toast("No round found");

  for (const fx of rnd.games){
    if (fx.played) continue;

    // Skip user match if present
    const isUserMatch = (fx.home === App.userClubId || fx.away === App.userClubId);
    if (isUserMatch) continue;

    const r = simAIGame(fx.home, fx.away);
    fx.homeG = r.homeG; fx.homeB = r.homeB;
    fx.awayG = r.awayG; fx.awayB = r.awayB;
    fx.homePts = r.homeG*6 + r.homeB;
    fx.awayPts = r.awayG*6 + r.awayB;
    fx.played = true;

    applyResultToLadder(fx);
  }

  saveCareer();
  toast("Sim complete", "Non-user games played");
  renderLadder();
  refreshTopBar();
}

function endRoundAdvance(){
  // Ensure all games are played (user match must be completed in Chunk 4)
  const rnd = currentRound();
  const allPlayed = rnd.games.every(g => g.played);
  if (!allPlayed){
    toast("Round not finished", "Play your match first (Chunk 4) or sim all later");
    return false;
  }

  if (App.season.roundIndex < App.season.rounds.length - 1){
    App.season.roundIndex++;
    saveCareer();
    toast("Round advanced", `Now Round ${App.season.roundIndex+1}`);
    refreshTopBar();
    renderHub();
    return true;
  }
  toast("Season complete", "Finals come in Chunk 5");
  return true;
}

// ---------- UI: Ladder render + user record ----------
window.getUserRecord = function(){
  if (!App.season || !App.userClubId) return null;
  const e = App.season.ladder[App.userClubId];
  if (!e) return null;
  return { w:e.wins, l:e.losses, d:e.draws };
};

window.renderLadder = function(){
  if (!App.hasCareer || !App.season){
    $("ladderTable").querySelector("tbody").innerHTML = `<tr><td colspan="8" style="color: var(--muted);">No season yet</td></tr>`;
    return;
  }

  const entries = Object.values(App.season.ladder)
    .slice()
    .sort((a,b)=>{
      const dPts = ladderPts(b) - ladderPts(a);
      if (dPts !== 0) return dPts;
      return ladderPct(b) - ladderPct(a);
    });

  const tbody = $("ladderTable").querySelector("tbody");
  tbody.innerHTML = "";

  entries.forEach((e, idx)=>{
    const club = App.league.clubs.find(c=>c.id===e.clubId);
    const tr = document.createElement("tr");
    const isUser = e.clubId === App.userClubId;
    tr.innerHTML = `
      <td class="mono">${idx+1}</td>
      <td>${escapeHtml(club.name)} ${escapeHtml(club.nick)} ${isUser ? '<span class="badge good">YOU</span>' : ''}</td>
      <td class="right mono">${e.played}</td>
      <td class="right mono">${e.wins}</td>
      <td class="right mono">${e.losses}</td>
      <td class="right mono">${e.draws}</td>
      <td class="right mono">${ladderPts(e)}</td>
      <td class="right mono">${ladderPct(e).toFixed(1)}</td>
    `;
    tbody.appendChild(tr);
  });
};

// ---------- Hook into career creation ----------
const prevGenerate = $("btnNewCareer").onclick;
$("btnNewCareer").onclick = ()=>{
  prevGenerate && prevGenerate();

  // Create season + fixture
  App.season = newSeason(2026);
  App.season.rounds = generateFixture23();
  saveCareer();

  toast("Season created", "23 rounds generated");
  refreshTopBar();
  renderMain();
};

// ---------- Hub: Sim rest of round / Play user match (stub route) ----------
$("btnSimRound").onclick = ()=>{
  if (!App.hasCareer || !App.season) return toast("No season yet");
  if (!App.userClubId) return toast("Pick your club first");
  simulateRestOfRound();
};

$("btnPlayMatch").onclick = ()=>{
  if (!App.hasCareer || !App.season) return toast("No season yet");
  if (!App.userClubId) return toast("Pick your club first");
  const rnd = currentRound();
  const userFx = rnd.games.find(g => g.home === App.userClubId || g.away === App.userClubId);
  if (!userFx) return toast("No user fixture found");

  // Setup match header (actual sim comes in Chunk 4)
  const homeClub = App.league.clubs.find(c=>c.id===userFx.home);
  const awayClub = App.league.clubs.find(c=>c.id===userFx.away);

  $("matchHeader").textContent = `Round ${rnd.number} ‚Ä¢ ${homeClub.name} ${homeClub.nick} vs ${awayClub.name} ${awayClub.nick}`;
  $("homeName").textContent = `${homeClub.name} ${homeClub.nick}`;
  $("awayName").textContent = `${awayClub.name} ${awayClub.nick}`;

  // reset scoreboard UI
  $("homeScore").textContent = "0.0 (0)";
  $("awayScore").textContent = "0.0 (0)";
  $("quarterLine").textContent = "Q1: 0-0 ‚Ä¢ Q2: 0-0 ‚Ä¢ Q3: 0-0 ‚Ä¢ Q4: 0-0";
  $("mQ").textContent = "0";
  $("mT").textContent = "‚Äî";
  $("feed").innerHTML = "";

  toast("Match ready", "Chunk 4 adds the live sim");
  go("match");
};

// ---------- Ensure season exists on load ----------
(function ensureSeasonOnLoad(){
  if (!App.hasCareer) return;
  if (App.league && !App.season){
    App.season = newSeason(2026);
    App.season.rounds = generateFixture23();
    saveCareer();
  }
  refreshTopBar();
})();
</script>

  <script>
(function hookAdvanceRound(){
  const btn = document.getElementById("btnAdvanceRound");
  if (!btn) return;

  btn.onclick = () => {
    if (!App.season) return toast("No season loaded");
    // Sim the AI games first (non-user)
    simulateRestOfRound();
    // If your match is played, this will advance
    endRoundAdvance();
    // Update UI
    refreshTopBar();
    renderHub();
    renderLadder();
  };
})();
</script>
  
</body>
</html>
